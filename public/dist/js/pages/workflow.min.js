$(function(){"use strict";var e,a={},t=function(e){var a=!0;return $.map(e,function(e){a=!$(e).val()&&a}),a},r=function(){var e=$("*[name=word_pattern\\.value]"),a=$("*[name=word_regex]"),t=$("*[name^=request_parameter_from_regex\\.]"),r=$("*[name=word_full_match]");return{word_pattern:e,word_regex:a,request_parameter_from_regex:t,word_full_match:r}},o=function(a){var t=content[a]||{},o=t.flow||{};return!!(e=t.type)&&void $(".modal-body").load("/views/"+e+".html",function(){$(".modal-title").text("");$(".modal-body");for(var t in o){var n=o[t];if("object"===$.type(n)){var s=0;for(var l in n){var d=$("*[name="+t+"\\.key]").eq(s).parents(".form-group");if($(Object.keys(n)).size()-1>s&&d.find(".add-row").trigger("click"),d.find("*[name="+t+"\\.key]").val(l),d.find("*[name="+t+"\\.value]").val(n[l]),"object"===$.type(n[l]))for(var i in n[l])d.find("*[name="+t+"\\.value\\."+i+"]").val(n[l][i]);s++}}else if("array"===$.type(n)){$(n).size();$.each(n,function(e,a){if("object"===$.type(a)){var r;if($("*[name="+t+"\\.value\\.type]").size()){var o=$("*[name="+t+"\\.value\\.type]").eq(e).parents(".form-group");o.find("*[name="+t+"\\.value\\.type]").val(a.type),o.find("*[name="+t+"\\.value\\.type]").val(a.type).trigger("change")}else var o=$("*[name="+t+"\\.value\\.title]").eq(e).parents(".form-group");r=a.type,$(n).size()-1>e&&o.find(".add-row").trigger("click");var s=!0;for(var l in a)"payload"===l&&a.payload.match(/^[0-9a-f]{32}$/)&&(s=!1);s&&"postback"===r&&o.find("*[name="+t+"\\.value\\.type]").val(r+"_custom").trigger("change");for(var l in a)a[l]&&"type"!==l&&o.find("*[name="+t+"\\.value\\."+l+"]").val(a[l])}else{var o=$("*[name="+t+"\\.value]").eq(e).parents(".form-group");$(n).size()-1>e&&o.find(".add-row").trigger("click"),$("*[name="+t+"\\.value]").eq(e).val(a)}})}else{var p=$("*[name="+t+"]").attr("type");switch(p){case"checkbox":1==n&&($("*[name="+t+"]").parent("div[class^=icheckbox]").addClass("checked"),$("*[name="+t+"]").prop("checked",!0));break;default:$("*[name="+t+"]").val(n)}}}$(".modal").removeClassPrefix("modal-"),$(".modal").addClass("modal-info"),$(".modal-footer button").text("儲存"),$(".modal-footer button").off("click"),$(".modal-footer button").on("click",function(t){t.stopPropagation(),t.preventDefault(),t.stopImmediatePropagation();var r=$(".modal").find("form"),o=r.find("input, select, textarea"),n=[];$.each(o,function(e,a){var t=$(a),r=t.attr("name");r&&(r=r.split("."),r=r[0],n.indexOf(r)===-1&&n.push(r))});var s={};$.each(n,function(e,a){var t=$("*[name="+a+"\\.key]").filter(function(){return!!this.value}),r=$("*[name="+a+"\\.value]").filter(function(){return!!this.value}),o=$("*[name^="+a+"\\.value\\.]").filter(function(){return!!this.value}),n=$("*[name="+a+"]").filter(function(){return!!this.value}),l={};$.each(o,function(e,t){var r=$(t).attr("name");r=r.replace(a+".value.",""),l[r]=l[r]||[],l[r].push($(t).val())});var d=[];$.each(l,function(e,a){$.each(a,function(a,t){t&&(d[a]=d[a]||{},d[a][e]=t.replace("postback_custom","postback"))})}),t.size()?r.size()?$.each(t,function(e,t){s[a]=s[a]||{},$(t).val()&&(s[a][$(t).val()]=r.eq(e).val())}):o.size()&&$.each(t,function(e,t){s[a]=s[a]||{},$(t).val()&&(s[a][$(t).val()]=d[e])}):o.size()?s[a]=d:n.size()?n.size()>1?$.each(n,function(e,t){s[a]=s[a]||[],$(t).val()&&s[a].push($(t).val())}):"checkbox"===n.attr("type")?n.parent().hasClass("checked")&&(s[a]=1):n.val()&&(s[a]=n.val()):r.size()&&$.each(r,function(e,t){s[a]=s[a]||[],$(t).val()&&s[a].push($(t).val())})}),s.request_endpoint&&"[object Array]"===Object.prototype.toString.call(s.response_payload_quick_replies_schema)&&1===s.response_payload_quick_replies_schema.length&&(s.response_payload_quick_replies_schema=s.response_payload_quick_replies_schema[0]),"[object Array]"===Object.prototype.toString.call(s.response_payload_elements_schema)&&1===s.response_payload_elements_schema.length&&(s.response_payload_elements_schema=s.response_payload_elements_schema[0]),s.answer_type=e,$.ajax({method:"PUT",data:JSON.stringify({step:a,payload:s}),dialog:!0}).done(function(){$.ajax({complete:function(e){content=e.responseJSON;for(var a in content){var t=$("<tr>"),r=content[a];t.append("<td>").find("td").last().attr("class","step").text(a).parent().append("<td>").find("td").last().attr("class","type").text(r.type).parent().append("<td>").find("td").last().attr("class","enter").text(r.enter).parent().append("<td>").find("td").last().append("<a>").find("a").last().attr("href","#").attr("data-step",a).addClass("btn").addClass("btn-primary").addClass("btn-sm").addClass("modify-target").text("編輯").parent().append("<a>").find("a").last().attr("href","/workflow/"+r.workflow).attr("data-step",a).addClass("btn").addClass("btn-danger").addClass("btn-sm").addClass("destroy-target").text("刪除"),$("*[data-step="+a+"]").size()?$("*[data-step="+a+"]").parents("tr").replaceWith(t):$(".add-chat").parents("tr").before(t)}}})})}),$("*[name=response_payload_buttons_schema\\.value\\.payload]").each(function(e,a){var t=$(location).attr("href"),r=t.match(/\/(\d+\-.+)($|\?)/);r=r[1]||"";var o=r.match(/(\d+)\-(.+)/);o=(parseInt(o[1],10)||0)+1;var n=o+"-"+$(a).val();$(a).prev("a").attr("href","/workflow/"+n+"?pattern="+$(a).val())});var m=$.param("pattern"),f=r();if(m&&1==a)f.word_pattern.attr("readonly",!0),f.word_pattern.val(m).parents(".form-group").find(".add-row").addClass("hide").parents(".form-group").find(".col-xs-8").addClass("col-xs-10").removeClass("col-xs-8"),f.word_regex.parents(".form-group").addClass("hide"),f.word_full_match.parents(".form-group").addClass("hide"),f.request_parameter_from_regex.parents(".form-group").addClass("hide");else for(var t in f)f[t].trigger("blur");$(".modal").modal("show")})};$(document).on("blur","*[name=word_pattern\\.value]",function(){var e=r();t(e.word_pattern)?(e.word_pattern.parents(".form-group").removeClass("hide"),e.word_full_match.parents(".form-group").removeClass("hide"),e.word_regex.parents(".form-group").removeClass("hide"),e.request_parameter_from_regex.parents(".form-group").removeClass("hide")):(e.word_regex.val("").parents(".form-group").addClass("hide"),e.request_parameter_from_regex.val("").parents(".form-group").addClass("hide"),e.word_pattern.parents(".form-group").removeClass("hide"),e.word_full_match.parents(".form-group").removeClass("hide"))}),$(document).on("blur","*[name=word_regex]",function(){var e=r();t(e.word_regex)?(e.word_pattern.parents(".form-group").removeClass("hide"),e.word_full_match.parents(".form-group").removeClass("hide"),e.word_regex.parents(".form-group").removeClass("hide"),e.request_parameter_from_regex.parents(".form-group").removeClass("hide")):(e.word_regex.parents(".form-group").removeClass("hide"),e.request_parameter_from_regex.parents(".form-group").removeClass("hide"),e.word_pattern.val("").parents(".form-group").addClass("hide"),e.word_full_match.val("").parents(".form-group").addClass("hide"),e.word_pattern.parents(".form-group").find("label").html("對應斷詞"),$.each(e.word_pattern,function(a,t){a<$(e.word_pattern).size()-1&&$(t).remove()}))}),$(document).on("blur","*[name^=request_parameter_from_regex\\.]",function(){var e=r();t(e.request_parameter_from_regex)?(e.word_pattern.parents(".form-group").removeClass("hide"),e.word_full_match.parents(".form-group").removeClass("hide"),e.word_regex.parents(".form-group").removeClass("hide"),e.request_parameter_from_regex.parents(".form-group").removeClass("hide")):(e.word_regex.parents(".form-group").removeClass("hide"),e.request_parameter_from_regex.parents(".form-group").removeClass("hide"),e.word_pattern.val("").parents(".form-group").addClass("hide"),e.word_full_match.val("").parents(".form-group").addClass("hide"),e.word_pattern.parents(".form-group").find("label").html("對應斷詞"),$.each(e.word_pattern,function(a,t){a<$(e.word_pattern).size()-1&&$(t).remove()}))}),$(document).on("click",".add-flow",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation(),$(".modal-body").load("/views/workflow.html",function(){$(".modal-title").text("新增一個對話"),$(".modal-footer > button").text("確定"),$(".modal").removeClassPrefix("modal-"),$(".modal").addClass("modal-primary"),$(".modal").modal("show"),$(".modal-footer > button").off("click"),$(".modal-footer > button").on("click",function(){var e=$("form").validate().form();if(e){var a=$(".modal-body form input[name=priority]").val(),t=$(".modal-body form input[name=name]").val();$(location).attr("href","/workflow/"+a+"-"+t)}})})}),$(document).on("click",".add-chat",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation(),$(".modal-body").load("/views/add_chat.html",function(){$(".modal-title").text("新增一個對話"),$(".modal").removeClassPrefix("modal-"),$(".modal").addClass("modal-primary"),$(".modal-footer > button").text("確定"),$(".modal").modal("show"),$(".modal-footer > button").off("click"),$(".modal-footer > button").on("click",function(){var e=$(".modal-body form select[name=flow-type]").val();if(e){var a=$(".step").last().text();a=(parseInt(a,10)||0)+1,content[a]={},content[a].type=e,o(a)}})})}),$(document).on("click",".destroy-target",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation();var a=$(this).attr("href"),t=this.attributes,r={},o=$(this).parents("tr");$.each(t,function(e,a){a.name.match(/^data-/)&&(r[a.name.substr(5)]=a.value)}),$(".modal-title").text("提示訊息"),$(".modal").removeClassPrefix("modal-"),$(".modal").addClass("modal-danger"),$(".modal-body").text("請再按一次確定，按了之後才會刪除您的資料"),$(".modal-footer > button").text("確定"),$(".modal").modal("show"),$(".modal-footer > button").off("click"),$(".modal-footer > button").on("click",function(){$.ajax({method:"DELETE",url:a,data:JSON.stringify(r),complete:function(){o.remove(),$(".modal").modal("hide")}})})}),$(document).on("click",".add-row",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation();var t=$(this).parents(".form-group"),r=t.find("input, select"),o=r.attr("name");switch(o=o.split("."),o=o[0],a[o]=a[o]||0,a[o]++,o){case"response_payload_buttons_schema":if(a[o]>=3)return;break;case"response_payload_quick_replies_schema":if(a[o]>=10)return;break;case"response_payload_elements_schema":if(a[o]>=10)return}var n=t.clone();n.find("label").text(""),n.find("input, select").val("").attr("readonly",!1),n.find(".is-hide").addClass("hide").removeClass(".is-hide"),$(this).parents(".form-group").after(n),$(this).parent().html(""),$(n).find("select, input").trigger("change")}),$(document).on("change",".quick-replies",function(){var e=$(this).val();switch($(this).parents(".form-group").find(".title").val(""),e){case"payload":var a=$(location).attr("href"),t=new Date/1,r=$.md5(t),o=a.match(/\/(\d+\-.+)($|\?)/);o=o[1]||"";var n=o.match(/(\d+)\-(.+)/);n=(parseInt(n[1],10)||0)+1;var s=n+"-"+r;$(this).parents(".form-group").find(".payload").html('<a class="btn btn-danger btn-sm" target="_blank" href="/workflow/'+s+"?pattern="+r+'"><i class="fa fa-wrench"></i> 修改按鈕內容</a><input type="hidden" name="response_payload_quick_replies_schema.value.payload" value="'+r+'">');break;default:case"payload_custom":$(this).parents(".form-group").find(".payload").html('<input class="form-control" name="response_payload_quick_replies_schema.value.payload" placeholder="payload">')}}),$(document).on("change","select[name=response_payload_buttons_schema\\.value\\.type]",function(){var e,a=$(this).val(),t=$(this).parents(".form-group").find(".title"),r=$(this).parents(".form-group").find(".payload"),o=$(this).parents(".form-group").find(".url");switch(t.addClass("is-hide").removeClass("hide"),a){case"web_url":r.find("input").val(""),t.find("input").val(""),r.addClass("hide").removeClass("is-hide"),o.addClass("is-hide").removeClass("hide");break;case"postback":var n=$(location).attr("href"),s=new Date/1,l=$.md5(s),d=n.match(/\/(\d+\-.+)($|\?)/);d=d[1]||"";var i=d.match(/(\d+)\-(.+)/);i=(parseInt(i[1],10)||0)+1;var p=i+"-"+l;r.html('<a class="btn btn-danger btn-sm" target="_blank" href="/workflow/'+p+"?pattern="+l+'"><i class="fa fa-wrench"></i> 修改按鈕內容</a><input type="hidden" name="response_payload_buttons_schema.value.payload" value="'+l+'">'),o.find("input").val(""),t.find("input").val(""),o.addClass("hide").removeClass("is-hide"),r.addClass("is-hide").removeClass("hide");break;case"postback_custom":e=e||"請帶入自定義的payload";case"phone_number":e=e||"電話以+886開頭",r.html('<input class="form-control" name="response_payload_buttons_schema.value.payload" placeholder="'+e+'">'),o.find("input").val(""),t.find("input").val(""),o.addClass("hide").removeClass("is-hide"),r.addClass("is-hide").removeClass("hide");break;default:r.find("input").val(""),o.find("input").val(""),t.find("input").val(""),o.addClass("hide").removeClass("is-hide"),t.addClass("hide").removeClass("is-hide"),r.addClass("hide").removeClass("is-hide")}}),$(document).on("click",".modify-target",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation();var a=$(this).attr("data-step");o(a)}),$(document).on("blur","*[name=request_endpoint]",function(e){e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation(),$(this).val()?($("*[name^=response_payload_quick_replies_schema]").parents(".form-group").find(".add-row").addClass("hide").parents(".form-group").find("label").html("快速回答"),$("*[name^=response_payload_quick_replies_schema]").parents(".form-group").find("label").html("快速回答"),$("*[name^=response_payload_quick_replies_schema]").parents(".form-group").each(function(e,a){e>0&&$(a).remove()})):$("*[name^=response_payload_quick_replies_schema]").last().parents(".form-group").find("label").html("快速回答").parents(".form-group").find(".add-row").removeClass("hide")})}(jQuery));